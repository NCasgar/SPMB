<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPMB Real-Time Monitor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; color: #1f2937; }
        .card { background-color: #ffffff; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); padding: 20px; }
        .loader {
            border: 3px solid #f3f3f3; border-top: 3px solid #4f46e5; border-radius: 50%;
            width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="p-6">

    <div class="max-w-7xl mx-auto mb-6 flex flex-col md:flex-row justify-between items-center">
        <div>
            <h1 class="text-3xl font-bold text-indigo-800">SPMB Monitor</h1>
            <p class="text-gray-500 text-sm">Live data directly from GitHub Raw (Bypassing Vercel Build)</p>
        </div>
        <div class="mt-4 md:mt-0 text-right">
            <div id="status" class="text-sm font-semibold text-gray-400 flex items-center gap-2">
                <div class="loader"></div> Connecting...
            </div>
            <button onclick="fetchData()" class="mt-2 text-xs bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full hover:bg-indigo-200 transition">
                Force Refresh
            </button>
        </div>
    </div>

    <div class="max-w-7xl mx-auto grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
        <div class="card border-l-4 border-blue-500">
            <p class="text-xs text-gray-400 uppercase font-bold">Last Update</p>
            <p id="lastDate" class="text-lg font-bold text-gray-800">--</p>
            <p id="lastTime" class="text-sm text-gray-500">--</p>
        </div>
        <div class="card border-l-4 border-red-500">
            <p class="text-xs text-gray-400 uppercase font-bold">Temperature</p>
            <p id="valTemp" class="text-2xl font-bold text-red-600">-- °C</p>
        </div>
        <div class="card border-l-4 border-blue-400">
            <p class="text-xs text-gray-400 uppercase font-bold">Humidity</p>
            <p id="valHum" class="text-2xl font-bold text-blue-600">-- %</p>
        </div>
        <div class="card border-l-4 border-indigo-500">
            <p class="text-xs text-gray-400 uppercase font-bold">Rain Status</p>
            <p id="valRain" class="text-2xl font-bold text-indigo-600">--</p>
        </div>
        <div class="card border-l-4 border-amber-500">
            <p class="text-xs text-gray-400 uppercase font-bold">Soil Moisture</p>
            <p id="valSoil" class="text-2xl font-bold text-amber-600">-- %</p>
        </div>
        <div class="card border-l-4 border-purple-500">
            <p class="text-xs text-gray-400 uppercase font-bold">Light Level</p>
            <p id="valLDR" class="text-2xl font-bold text-purple-600">--</p>
        </div>
        <div class="card border-l-4 border-cyan-500">
            <p class="text-xs text-gray-400 uppercase font-bold">Water Level</p>
            <p id="valWater" class="text-2xl font-bold text-cyan-600">-- cm</p>
        </div>
    </div>

    <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <div class="card">
            <h3 class="text-gray-500 font-bold text-sm mb-4">Temperature & Humidity</h3>
            <canvas id="chartTempHum"></canvas>
        </div>
        <div class="card">
            <h3 class="text-gray-500 font-bold text-sm mb-4">Soil & Water</h3>
            <canvas id="chartSoilWater"></canvas>
        </div>
    </div>

    <div class="max-w-7xl mx-auto card overflow-hidden">
        <h3 class="text-gray-500 font-bold text-sm mb-4">Recent History (Last 20 Entries)</h3>
        <div class="overflow-x-auto">
            <table class="w-full text-sm text-left text-gray-500">
                <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                    <tr>
                        <th class="px-4 py-3">Date</th>
                        <th class="px-4 py-3">Time</th>
                        <th class="px-4 py-3">Temp</th>
                        <th class="px-4 py-3">Hum</th>
                        <th class="px-4 py-3">Soil</th>
                        <th class="px-4 py-3">Rain</th>
                        <th class="px-4 py-3">Light</th>
                        <th class="px-4 py-3">Water</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    </tbody>
            </table>
        </div>
    </div>

<script>
    // --- CONFIGURATION ---
    const GITHUB_USERNAME = "NCasgar";
    const REPO_NAME = "SPMB";
    const BRANCH_NAME = "main";
    const FILE_PATH = "data.csv";

    // Chart Instances
    let chart1, chart2;

    // Run on load and every 5 seconds
    document.addEventListener("DOMContentLoaded", () => {
        fetchData();
        setInterval(fetchData, 5000); // Auto-refresh every 5 seconds
    });

    // --- MAIN FUNCTION: Fetch Data from GitHub Raw ---
    function fetchData() {
        const statusEl = document.getElementById("status");
        
        // 1. Construct URL
        const rawUrl = `https://raw.githubusercontent.com/${GITHUB_USERNAME}/${REPO_NAME}/${BRANCH_NAME}/${FILE_PATH}`;
        
        // 2. THE SECRET: Add a timestamp to the URL to bypass the cache
        const cacheBuster = rawUrl + '?t=' + new Date().getTime();

        console.log("Fetching: " + cacheBuster);

        fetch(cacheBuster)
            .then(response => {
                if (!response.ok) throw new Error("File not found on GitHub");
                return response.text();
            })
            .then(csvText => {
                const data = parseCSV(csvText);
                updateUI(data);
                statusEl.innerHTML = '<span class="text-green-500">● Live (Direct from GitHub)</span>';
            })
            .catch(error => {
                console.error(error);
                statusEl.innerHTML = '<span class="text-red-500">Error loading data</span>';
            });
    }

    // --- PARSER ---
    function parseCSV(text) {
        const lines = text.trim().split("\n");
        const headers = lines[0].split(",");
        const result = [];

        // Parse lines (skip header)
        for (let i = 1; i < lines.length; i++) {
            const row = lines[i].split(",");
            if (row.length < 8) continue; // Skip incomplete lines

            result.push({
                date: row[0],
                time: row[1],
                temp: parseFloat(row[2]),
                hum: parseFloat(row[3]),
                soil: parseFloat(row[4]),
                rain: row[5],
                ldr: parseFloat(row[6]),
                water: parseFloat(row[7])
            });
        }
        return result;
    }

    // --- UI UPDATER ---
    function updateUI(data) {
        if (data.length === 0) return;

        // 1. Update Latest Cards
        const last = data[data.length - 1];
        document.getElementById("lastDate").textContent = last.date;
        document.getElementById("lastTime").textContent = last.time;
        document.getElementById("valTemp").textContent = last.temp + " °C";
        document.getElementById("valHum").textContent = last.hum + " %";
        document.getElementById("valRain").textContent = last.rain;
        document.getElementById("valSoil").textContent = last.soil + " %";
        document.getElementById("valLDR").textContent = last.ldr;
        document.getElementById("valWater").textContent = last.water + " cm";

        // 2. Update Table (Show last 20 reversed)
        const tableBody = document.getElementById("tableBody");
        tableBody.innerHTML = "";
        const recentData = data.slice().reverse().slice(0, 20);
        
        recentData.forEach(row => {
            const tr = `
                <tr class="bg-white border-b hover:bg-gray-50">
                    <td class="px-4 py-2">${row.date}</td>
                    <td class="px-4 py-2">${row.time}</td>
                    <td class="px-4 py-2 font-medium text-red-600">${row.temp}</td>
                    <td class="px-4 py-2 text-blue-600">${row.hum}</td>
                    <td class="px-4 py-2 text-amber-600">${row.soil}</td>
                    <td class="px-4 py-2">${row.rain}</td>
                    <td class="px-4 py-2 text-purple-600">${row.ldr}</td>
                    <td class="px-4 py-2 text-cyan-600">${row.water}</td>
                </tr>`;
            tableBody.innerHTML += tr;
        });

        // 3. Update Charts
        updateCharts(data);
    }

    // --- CHART LOGIC ---
    function updateCharts(data) {
        // Limit chart to last 50 points to keep it clean
        const chartData = data.slice(-50);
        const labels = chartData.map(d => d.time);

        // Chart 1: Temp & Hum
        const ctx1 = document.getElementById('chartTempHum').getContext('2d');
        if (chart1) chart1.destroy();
        chart1 = new Chart(ctx1, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    { label: 'Temp', data: chartData.map(d => d.temp), borderColor: '#ef4444', tension: 0.1 },
                    { label: 'Humidity', data: chartData.map(d => d.hum), borderColor: '#3b82f6', tension: 0.1 }
                ]
            },
            options: { responsive: true, elements: { point: { radius: 1 } } }
        });

        // Chart 2: Soil & Water
        const ctx2 = document.getElementById('chartSoilWater').getContext('2d');
        if (chart2) chart2.destroy();
        chart2 = new Chart(ctx2, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    { label: 'Soil', data: chartData.map(d => d.soil), borderColor: '#d97706', tension: 0.1 },
                    { label: 'Water', data: chartData.map(d => d.water), borderColor: '#06b6d4', tension: 0.1 }
                ]
            },
            options: { responsive: true, elements: { point: { radius: 1 } } }
        });
    }
</script>
</body>
</html>
